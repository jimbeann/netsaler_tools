<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NetScaler Upgrade Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; }
    textarea { white-space: pre-wrap; font-family: monospace; }
    .tab-content { margin-top: 20px; }
    .checklist label { margin-left: 10px; }
  </style>
</head>
<body>
  <h2 class="mb-4">NetScaler Upgrade Tool</h2>

  <ul class="nav nav-tabs" id="tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="mop-tab" data-bs-toggle="tab" data-bs-target="#mop" type="button">Upgrade MOP</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="checklist-tab" data-bs-toggle="tab" data-bs-target="#checklist" type="button">Progress Checklist</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="validation-tab" data-bs-toggle="tab" data-bs-target="#validation" type="button">NS Validation Compare</button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Tab 1: MOP Generator -->
    <div class="tab-pane fade show active" id="mop">
      <div class="row mt-3">
        <div class="col-md-4">
          <label>Firmware Version:</label>
          <input type="text" class="form-control" id="version" placeholder="e.g. 13.1-59.19">
          <label class="mt-2">LB Hostname:</label>
          <input type="text" class="form-control" id="lb" value="load balancer host name">
          <label class="mt-2">User ID:</label>
          <input type="text" class="form-control" id="userid" value="your ldap id">
          <button class="btn btn-primary mt-3" onclick="generateMOP()">Generate MOP</button>
        </div>
        <div class="col-md-8">
          <label>Generated MOP:</label>
          <textarea class="form-control" id="output" rows="30"></textarea>
        </div>
      </div>
    </div>

    <!-- Tab 2: Checklist -->
    <div class="tab-pane fade" id="checklist">
      <div class="mt-3">
        <h4>Upgrade Progress</h4>
        <div class="progress mb-3">
          <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
        </div>
        <div class="checklist">
          <div class="form-check"><input class="form-check-input" type="checkbox" onchange="updateProgress()"><label>Run batch -f /var/tmp/NS-VALIDATIONS (Precheck)</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" onchange="updateProgress()"><label>Check: show ha node</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" onchange="updateProgress()"><label>Check: df -h</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" onchange="updateProgress()"><label>Backup Configs and SSL</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" onchange="updateProgress()"><label>Copy Firmware to NetScaler</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" onchange="updateProgress()"><label>Upgrade Secondary Node</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" onchange="updateProgress()"><label>Failover to Secondary</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" onchange="updateProgress()"><label>Upgrade Primary Node</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" onchange="updateProgress()"><label>Re-enable HA Sync/Propagation</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" onchange="updateProgress()"><label>Run batch -f /var/tmp/NS-VALIDATIONS (Postcheck)</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" onchange="updateProgress()"><label>Validate services and show ns version</label></div>
        </div>
      </div>
    </div>

    <!-- Tab 3: NS Validation Compare -->
    <div class="tab-pane fade" id="validation">
      <div class="row mt-3">
        <div class="col-md-6">
          <label>Pre-upgrade Output:</label>
          <textarea class="form-control" id="preValidation" rows="15"></textarea>
        </div>
        <div class="col-md-6">
          <label>Post-upgrade Output:</label>
          <textarea class="form-control" id="postValidation" rows="15"></textarea>
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-success" onclick="compareValidation()">Compare</button>
        <div class="mt-2">
          <label>Differences:</label>
          <pre class="border p-2" id="diffResult"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    function generateMOP() {
      const version = document.getElementById('version').value.trim();
      const lb = document.getElementById('lb').value.trim();
      const user = document.getElementById('userid').value.trim();

      const mop = `============================ COPY FIRMWARE ============================
cd /var/nsinstall/
mkdir build-${version}
scp build-${version}_nc_64.tgz T1-${user}@${lb}:/var/nsinstall/build-${version}/build-${version}_nc_64.tgz

============================ BACKUP CONFIG ============================
create system backup full_${lb}_preupgrade -level full -comment "preupgrade"
shell
cd /var/tmp
mkdir ${lb}-backup
cp /var/ns_sys_backup/full_${lb}_preupgrade.tgz /var/tmp/${lb}-backup/
cd /var/tmp/${lb}-backup
mkdir ssl
cp -r /nsconfig/ssl/* /var/tmp/${lb}-backup/ssl/
cd /var/tmp
tar -zcv -f ${lb}-backup.tgz /var/tmp/${lb}-backup
scp T1-${user}@${lb}:/var/tmp/${lb}-backup.tgz ./

============================ UPGRADE ============================
cd /var/nsinstall/build-${version}
tar -xzvf build-${version}_nc_64.tgz
./installns

show ns version
show ha node
set ha node -hasync DISABLED
force failover
show ha node

============================ ROLLBACK (IF REQUIRED) ============================
# On SECONDARY:
show ha node
batch -f /var/tmp/NS-VALIDATIONS
shell
cp /nsconfig/ns.conf /nsconfig/ns.conf.${version}
cp /nsconfig/ZebOS.conf /nsconfig/ZebOS.conf.${version}
cd /var/nsinstall/build-<rollback-version>
./installns

# On PRIMARY:
show ha node
set ha node -hasync DISABLED -haprop DISABLED
batch -f /var/tmp/NS-VALIDATIONS
force failover

# Downgrade second node:
show ha node
shell
cp /nsconfig/ns.conf /nsconfig/ns.conf.${version}
cp /nsconfig/ZebOS.conf /nsconfig/ZebOS.conf.${version}
cd /var/nsinstall/build-<rollback-version>
./installns

# After Both Nodes Reboot:
set ha node -hasync ENABLED -haprop ENABLED
show ha node
show ns version`;

      document.getElementById('output').value = mop;
    }

    function updateProgress() {
      const checks = document.querySelectorAll('#checklist .form-check-input');
      const completed = Array.from(checks).filter(c => c.checked).length;
      const percent = Math.round((completed / checks.length) * 100);
      const bar = document.getElementById('progressBar');
      bar.style.width = percent + '%';
      bar.innerText = percent + '%';
    }

    function compareValidation() {
      const pre = document.getElementById('preValidation').value.trim().split('\n');
      const post = document.getElementById('postValidation').value.trim().split('\n');
      let diff = '';
      for (let i = 0; i < Math.max(pre.length, post.length); i++) {
        if (pre[i] !== post[i]) {
          diff += `Line ${i+1} differs:\n  Pre:  ${pre[i] || ''}\n  Post: ${post[i] || ''}\n\n`;
        }
      }
      document.getElementById('diffResult').textContent = diff || 'No differences detected.';
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
